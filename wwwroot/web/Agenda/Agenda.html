<div class="pure-g">
    <div class="pure-u-1-1 pure-u-md-1-5 lateralMenu">
        <div class="lateralMenuHeader">
        </div>
        <div class="lateralMenuGroup">
            <div class="lateralMenuItem noSelect group" style="padding-left: 8px; cursor: auto;">
                Agenda
            </div>
        </div>
        <div class="lateralMenuGroup">
            <div v-on:click="setMainMode(0)" class="lateralMenuItem noSelect"
                v-bind:class="{'lateralMenuItemSelected': mode == 0}">
                <img src="./img/ico/svg/sidebar/Compromisos.svg" />
                Mis Tareas
            </div>
            <div v-on:click="setMainMode(1)" class="lateralMenuItem noSelect"
                v-bind:class="{'lateralMenuItemSelected': mode == 1}">
                <img src="./img/ico/svg/sidebar/Mi Calendario.svg" />
                Mi Calendario
            </div>
        </div>
    </div>
    <div class="pure-u-1-1 pure-u-md-4-5">
        <div style="font-size: 1rem; border-bottom: 1px solid rgb(231, 231, 231); padding: 0.5rem 1rem;">
            <div style="display: inline;" v-for="(r, i) in ruta.filter(r => r.text)" @click="r.action">
                <span class="hoverLink">{{ r.text }}</span>
                <span v-if="i < ruta.length - 1"> / </span>
            </div>
        </div>
        <div v-if="mode == 0" style="padding: 1em">
            <div class="pure-u-1-24 pure-u-md-1-24"></div>
            <div class="pure-u-22-24 pure-u-md-22-24 menuCard">
                <h2 style="margin-bottom: .5rem;">{{usuario.nombres}}</h2>
                <div class='pure-u-1-1 pure-u-md-1-1 formDivision' style="font-size: 1.5em; margin-bottom: 4px;">
                    Fecha de hoy: {{ new Date().toLocaleDateString() }}
                </div>

                <div class='pure-u-1-2 pure-u-md-1-12' style="text-align: center; padding-top: 14px;">
                    <label for="sel-pro" style="padding-top: .5rem;">Proyecto: </label>
                </div>
                <div class='pure-u-1-2 pure-u-md-1-6 formInputStandard'>
                    <select v-model="selPro" class="pure-input-1" @change="onChangePro" id="sel-pro">
                        <option :value="{}">[Todos]</option>
                        <option v-for="pro in proyectos" :value="pro">{{pro.nombre}}</option>
                    </select>
                </div>
                <div class='pure-u-1-1 pure-u-md-1-24'></div>
                <div class='pure-u-1-1 pure-u-md-1-4' style="padding-top: 14px;">
                    <label class="check">
                        <input type="checkbox" :checked="filtros.tareas.activa" @change="onChangeActive" />
                        <span class="checkmark"></span>
                        Mostrar solo tareas activas
                    </label>
                </div>
                <div class='pure-u-1-1 pure-u-md-1-12' style="text-align: center; padding-top: 14px;">
                    <label for="sel-orden">Orden: </label>
                </div>
                <div class='pure-u-1-1 pure-u-md-1-6 formInputStandard' style="text-align: left;">
                    <select id="sel-orden" v-model="orden">
                        <option value="dead-prio">Deadline - Prioridad</option>
                        <option value="prio-dead">Prioridad - Deadline</option>
                    </select>
                </div>
                <div class='pure-u-1-1 pure-u-md-5-24' style="text-align: right; padding-top: .5rem;">
                    <button @click="newRow()">Agregar Tarea</button>
                </div>

                <div style="height: calc(100vh - 25rem); overflow-y: auto;">
                    <table class="dataTable" style="table-layout: auto;">
                        <thead>
                            <tr>
                                <th style="width: 13%;">Alta</th>
                                <th style="width: 13%;">Deadline</th>
                                <th style="width: 16%;">Proyecto</th>
                                <th style="width: 32%;">Descripción</th>
                                <th style="width: 13%;">Prioridad</th>
                                <th style="width: 13%;">Estado</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-if="editNewRow" class="editable" v-bind:class="{'destacada': selRow == null}">
                                <td><input type="date" v-model="tarea.alta"></td>
                                <td><input type="date" v-model="tarea.deadline"></td>
                                <td>
                                    <select v-model="tarea.id_proyecto">
                                        <option value="" disabled>[Seleccione]</option>
                                        <option v-for="pro in proyectos" :value="pro.id_proyecto">{{pro.nombre}}
                                        </option>
                                    </select>
                                </td>
                                <td><input type="text" v-model="tarea.descripcion"></td>
                                <td>
                                    <select v-model="tarea.id_prioridad">
                                        <option value="" disabled>[Seleccione]</option>
                                        <option v-for="p in prioridades" :value="p.id_prioridad">{{p.nombre}}</option>
                                    </select>
                                </td>
                                <td>
                                    <select v-model="tarea.id_estado">
                                        <option value="" disabled>[Seleccione]</option>
                                        <option v-for="e in estados" :value="e.id_estado">{{e.nombre}}</option>
                                    </select>
                                </td>
                            </tr>
                            <tr v-for="(t, i) in getFilteredList('tareas')" @click="onSelect(t, i)"
                                v-bind:class="{'destacada': selRow == i, 'editable': enableEdit && selRow == i, 'deshabilitada': t.id_estado == '4'}">
                                <td>
                                    <input type="date" v-model="t.alta" v-if="enableEdit && selRow == i">
                                    <span v-else>{{t.alta}}</span>
                                </td>
                                <td>
                                    <input type="date" v-model="t.deadline" v-if="enableEdit && selRow == i">
                                    <span v-else>{{t.deadline}}</span>
                                </td>
                                <td>
                                    <select v-model="t.id_proyecto" v-if="enableEdit && selRow == i">
                                        <option value="" disabled>[Seleccione]</option>
                                        <option v-for="pro in proyectos" :value="pro.id_proyecto">{{pro.nombre}}
                                        </option>
                                    </select>
                                    <span v-else>{{t.proyecto}}</span>
                                </td>
                                <td>
                                    <input type="text" v-model="t.descripcion" v-if="enableEdit && selRow == i">
                                    <span v-else>{{t.descripcion}}</span>
                                </td>
                                <td style="text-align: center;">
                                    <select v-model="t.id_prioridad" v-if="enableEdit && selRow == i">
                                        <option value="" disabled>[Seleccione]</option>
                                        <option v-for="p in prioridades" :value="p.id_prioridad">{{p.nombre}}</option>
                                    </select>
                                    <span v-else>{{t.prioridad}}</span>
                                </td>
                                <td style="text-align: center;">
                                    <select v-model="t.id_estado" v-if="enableEdit && selRow == i">
                                        <option value="" disabled>[Seleccione]</option>
                                        <option v-for="e in estados" :value="e.id_estado">{{e.nombre}}</option>
                                    </select>
                                    <span v-else>{{t.estado}}</span>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class='pure-u-1-1 pure-u-md-7-12'></div>
                <div class='pure-u-1-1 pure-u-md-5-24' style="text-align: center; padding-top: .5rem;">
                    <button @click="enableEdit = true">Editar Tarea</button>
                </div>
                <div class='pure-u-1-1 pure-u-md-5-24' style="text-align: center; padding-top: .5rem;">
                    <button @click="reqDelete">Eliminar Tarea</button>
                </div>
            </div>
            <div class='pure-u-1-1 pure-u-md-2-5'></div>
            <div class='pure-u-1-1 pure-u-md-1-5' style="text-align: center; padding-top: 1rem;">
                <button @click="onSave">Guardar</button>
            </div>
        </div>
        <div v-if="mode == 1" style="padding: 1em;">
            <div class="pure-u-1-24 pure-u-md-1-24"></div>
            <div class="pure-u-22-24 pure-u-md-22-24 menuCard" style="height: calc(100vh - 8rem)">
                <div style="padding-bottom: 5px; border-bottom: 1px solid #00839C;">
                    <div class='pure-u-1-3 pure-u-md-3-8 formDivision' style="font-size: 1.5em; border: 0;">
                        Fecha actual: {{ formatDatetime(null, 'date') }}
                    </div>
                    <div class='pure-u-2-3 pure-u-md-10-24 formDivision' style="font-size: 1.5em; border: 0;">
                        Fecha seleccionada: {{ formatDatetime(null, 'date', selDate) }}
                    </div>
                    <div class="pure-u-1-1 pure-u-md-5-24" style="text-align: end;">
                        <div @click="!isToday() && setToday()" class="cal-btn today"
                            :style="isToday() ? 'background-color: #636363;' : ''">Ir a Hoy</div>
                        <div @click="setDate(-1)" class="cal-btn"
                            style="border-top-right-radius: 0; border-bottom-right-radius: 0;">&lt;</div>
                        <div @click="setDate(1)" class="cal-btn"
                            style="border-top-left-radius: 0; border-bottom-left-radius: 0;">
                            &gt;</div>
                    </div>
                </div>
                <div style="display: flex; align-items: center; padding: 5px 0;">
                    <div class="pure-u-1-1 pure-u-md-1-3">
                        <div class="btn-view-group">
                            <div class="radio-group cal-opc">
                                <label v-for="opt in optionMode" :for="`view-${opt.class}`">
                                    <input type="radio" name="view" :id="`view-${opt.class}`"
                                        :checked="viewMode.class == opt.class" @click="updateViewMode(opt.class)" />
                                    <span>{{opt.name}}</span>
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="pure-u-1-1 pure-u-md-1-12"></div>
                    <div class="pure-u-1-1 pure-u-md-3-8">
                        <!-- <div class="btn-view-group">
                            <div class="radio-group" style="gap: 1rem; padding-top: 0;">
                                <button style="padding: 5px .5rem;" @click="openModal(1)">Agregar Hito</button>
                                <button style="padding: 5px .5rem;" @click="toggleHoliday">
                                    {{currentDay.isHoliday ? 'Desmarcar festivo' : 'Marcar festivo'}}
                                </button>
                            </div>
                        </div> -->
                    </div>
                    <div class="pure-u-1-1 pure-u-md-1-12"></div>
                    <div class="pure-u-1-1 pure-u-md-5-24">
                        <select v-model="pro_filter" @change="setViewMonths">
                            <option :value="null">Todas la salas</option>
                            <option v-for="pro in proyectos" :value="pro.id_proyecto">
                                {{pro.nombre}}
                            </option>
                        </select>
                    </div>
                </div>

                <div style="display: flex; gap: 5px; height: calc(100vh - 16rem);">
                    <div
                        :class="`calendar pure-u-1-1 ${viewMode.class == 'm6' || viewMode.class == 'm12' ? 'pure-u-md-1-1' : 'pure-u-md-1-3'} ` + viewMode.class">
                        <div class="cal-month"
                            v-for="i in Array.from({length: viewMode.months}, (_, i) => i + viewMode.initMonth)"
                            v-bind:class="{'cal-sel-month': viewMonths[nameMonths[i]].selected}">
                            <div class="cal-header">
                                <div class="cal-name-month">
                                    <span>{{`${nameMonths[i]} - ${viewMonths[nameMonths[i]].year}`}}</span>
                                </div>
                            </div>
                            <div class="cal-header">
                                <div class="cal-name-day" v-for="name in nameDays">
                                    <span>{{name}}</span>
                                </div>
                            </div>
                            <div class="cal-matrix">
                                <div class="cal-day" v-for="day in viewMonths[nameMonths[i]].days"
                                    :id="`mat-m${day.month}-d${day.monthDay}-${day.currentMonth ? 'c' : day.viewMonth}`"
                                    v-bind:class="{'cal-today': day.isToday, 'cal-fade-day': !day.currentMonth, 
                            'cal-sel-day': day.isSelected, 'cal-holiday': day.isHoliday, 
                            'cal-sel-week': viewMode.class == 's1' && currentDay.weekCount == day.weekCount && i == currentDay.month}"
                                    @click="day.currentMonth && selDay(day, true)" :style="day.events && day.events.filter(e => e.festivo != '1').length ? 
                            `background-color: ${day.events.filter(e => e.festivo != '1')[0].color}40;` : ''"
                                    @dblclick="day.currentMonth && day.events && day.events.filter(e => e.festivo != '1').length && openModal(3)">
                                    <span>
                                        {{day.monthDay}}
                                    </span>
                                    <div class="hide-editor" v-bind:class="{'cal-event-count': day.events && 
                            day.events.filter(e => e.festivo != '1').length}">
                                        <span>{{day.events.filter(e => e.festivo != '1').length}}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="pure-u-1-1 pure-u-md-2-3 cal-table"
                        v-if="viewMode.class == 's1' || viewMode.class == 'm1'">
                        <table class="dataTable">
                            <thead>
                                <tr>
                                    <th style="width: 16%;">Fecha</th>
                                    <th style="width: 33%;">Titulo</th>
                                    <th style="width: 14%;">Tipo</th>
                                    <th style="width: 21%;">Categorías (#)</th>
                                    <th style="width: 16%;">Hora</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-for="day in tableDays" @click="day.day.currentMonth && selDay(day.day)"
                                    @dblclick="day.day.currentMonth && day.event ? (openModal(2, day.event)) : day.day.currentMonth ? openModal(1) : null"
                                    :id="`tab-m${day.day.month}-d${day.day.monthDay}`"
                                    v-bind:class="{'cal-table-selected': day.day.isSelected, 'cal-table-today': day.day.isToday, 'cal-deshabilitada': !day.day.currentMonth}"
                                    :style="day.color ? 'background: ' + day.color + '40;' : day.day.isSelected ? 'background: #ddd;' : null">
                                    <td>{{formatDatetime(null, 'date', day.day.date)}}</td>
                                    <td>{{day.e_titulo}}</td>
                                    <td>{{day.e_tipo}}</td>
                                    <td :style="day.e_categorias.length > 1 ? 'padding: 0;' : ''">
                                        <span v-if="!day.e_categorias.length">-</span>
                                        <span v-else-if="day.e_categorias.length == 1">{{day.e_categorias[0]}}</span>
                                        <div v-else style="text-align: center;"
                                            @mouseenter="tooltipVisible = true; tooltipMsg = day.e_categorias.join(`&lt;br&gt;`)"
                                            @mouseleave="tooltipVisible = false;" @mousemove="updateCursor">
                                            <span class="cal-event-count">{{day.e_categorias.length}}</span>
                                        </div>
                                    </td>
                                    <td>{{day.e_hora}}</td>
                                </tr>
                            </tbody>
                        </table>
                        <div v-if="tooltipVisible" class="cursor-tooltip" v-html="tooltipMsg"
                            :style="{ top: tooltipY + 'px', left: tooltipX + 'px' }">
                        </div>
                    </div>
                </div>
            </div>
            <div class="cal-modal-overlay" id="modalOverlay" @click="closeModal($event)">
                <div class="modal-container pure-g" v-if="modalmode == 1 || modalmode == 2">
                    <div class="modal-scroll">
                        <img src="../../img/ico/svg/cerrar-transparente.svg" @click="closeModal($event, true)"
                            class="modal-cerrar">
                        <div class='pure-u-1-1 pure-u-md-1-1'>
                            <h2 style="text-align: center;">{{ formatDatetime(null, 'date', selDate) }}</h2>
                        </div>
                        <div class='pure-u-1-1 pure-u-md-1-1 formInputStandard'>
                            <span>Titulo</span>
                            <input type='text' maxlength="100" v-model="hito.titulo" />
                        </div>
                        <div class='pure-u-7-24 pure-u-md-7-24 formInputStandard'>
                            <span>Tipo de Hito</span>
                            <div style="display: flex; justify-content: space-around;">
                                <select v-model="eventType" @change="eventType == 'Sala' && (id_obj = null);">
                                    <option value="Sala">Sala</option>
                                    <option value="Proyecto">Proyecto</option>
                                    <option value="Torre">Torre</option>
                                    <option value="Inmueble">Inmueble</option>
                                </select>
                            </div>
                        </div>
                        <div class='pure-u-7-24 pure-u-md-7-24 formInputStandard'>
                            <span>{{eventType}}</span>
                            <div style="display: flex; justify-content: space-around;">
                                <select :disabled="eventType !== 'Proyecto'" v-model="id_obj">
                                    <option v-if="eventType == 'Sala'" :value="null">{{hito.sala_venta}}</option>
                                    <option v-if="eventType == 'Proyecto'" v-for="pro in proyectos"
                                        :value="pro.id_proyecto">
                                        {{pro.nombre}}
                                    </option>
                                </select>
                            </div>
                        </div>
                        <div class='pure-u-5-24 pure-u-md-5-24 formInputStandard' style="text-align: center;">
                            <span>Color</span>
                            <input type='color' v-model="hito.color" style="margin-top: 2px;" />
                        </div>
                        <div class='pure-u-5-24 pure-u-md-5-24 formInputStandard'>
                            <span>Hora</span>
                            <input type='time' v-model="hito.hora" />
                        </div>

                        <span style="display: block; padding: .5rem; padding-bottom: 0;">
                            Agendar a las categorías:
                        </span>
                        <div class="modal-check-cont">
                            <div class='pure-u-1-2 pure-u-md-1-6' v-for="cargo in cargos">
                                <label class="check">
                                    <input type="checkbox" value='1' v-model="cargo.checked" />
                                    <span class="checkmark"></span>
                                    {{cargo.cargo}}
                                </label>
                            </div>
                        </div>

                        <div class='pure-u-1-1 pure-u-md-4-5 formInputStandard' style="padding: .5rem;">
                            <span>Repetir</span>
                            <div class="radio-group cal-opc" style="width: 98%;">
                                <label v-for="fre in frecuencias" :for="`freq-${fre.name}`" @click="onChangeFreq(fre)">
                                    <input type="radio" name="freq" :id="`freq-${fre.name}`" :checked="fre.checked" />
                                    <span>{{fre.name}}</span>
                                </label>
                            </div>
                        </div>
                        <div class='pure-u-1-1 pure-u-md-1-5 formInputStandard' style="padding: .5rem;">
                            <span>Hasta</span>
                            <input type="date" v-model="hito.limite" style="margin-top: 2px;"
                                :disabled="!hito.frecuencia">
                        </div>

                        <div class='pure-u-1-1 pure-u-md-1-1 formInputStandard'>
                            <span>Descripción</span>
                            <textarea maxlength="255" v-model="hito.descripcion"
                                style="width: 100%; height: 100px; resize: none; font-size: 14px;"></textarea>
                        </div>
                        <div style="display: flex; width: 100%; gap: 4rem; justify-content: center;">
                            <div class='pure-u-1-1 pure-u-md-1-4 formInputStandard'>
                                <button @click="onCancel">Cancelar</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="modal-container pure-g" v-if="modalmode == 3" style="position: relative;">
                    <img src="../../img/ico/svg/cerrar-transparente.svg" @click="closeModal($event, true)"
                        class="modal-cerrar events">
                    <div class="pure-u-1-1">
                        <h2 style="text-align: center; margin-bottom: 1rem;">
                            Hitos del {{ formatDatetime(null, 'date', selDate) }}
                        </h2>
                    </div>
                    <div class="event-list">
                        <div v-for="e in currentDay.events.filter(e => e.festivo != '1')" class="event-card pure-g" @click="selEvent(e)"
                            :style="`border: 1px solid ${e.color}90; border-left: 6px solid ${e.color}; background-color: ${e.color}10;`">
                            <div class="pure-u-5-6 pure-u-md-5-6">
                                <h4 class="event-title">
                                    {{ e.titulo }} - {{ e.id_proyecto ? e.nombre_pro : e.sala_venta }} - {{
                                    formatDatetime(e.fecha, 'time') }} ({{(frecuencias.find(f => f.value ==
                                    e.frecuencia) ||
                                    frecuencias[0]).name}})
                                </h4>
                                <p class="event-description">{{ e.descripcion }}</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>