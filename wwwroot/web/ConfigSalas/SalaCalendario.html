<div style="padding: 1em">
    <div class="pure-u-1-24 pure-u-md-1-24"></div>
    <div class="pure-u-22-24 pure-u-md-22-24 menuCard" style="height: calc(100vh - 8rem)">
        <div style="padding-bottom: 5px; border-bottom: 1px solid #00839C;">
            <div class='pure-u-1-3 pure-u-md-3-8 formDivision' style="font-size: 1.5em; border: 0;">
                Fecha actual: {{ formatDatetime(null, 'date') }}
            </div>
            <div class='pure-u-2-3 pure-u-md-10-24 formDivision' style="font-size: 1.5em; border: 0;">
                Fecha seleccionada: {{ formatDatetime(null, 'date', selDate) }}
            </div>
            <div class="pure-u-1-1 pure-u-md-5-24" style="text-align: end;">
                <div @click="!isToday() && setToday()" class="cal-btn today"
                    :style="isToday() ? 'background-color: #636363;' : ''">Ir a Hoy</div>
                <div @click="setDate(-1)" class="cal-btn"
                    style="border-top-right-radius: 0; border-bottom-right-radius: 0;">&lt;</div>
                <div @click="setDate(1)" class="cal-btn"
                    style="border-top-left-radius: 0; border-bottom-left-radius: 0;">
                    &gt;</div>
            </div>
        </div>
        <div style="display: flex; align-items: center; padding: 5px 0;">
            <div class="pure-u-1-1 pure-u-md-1-3">
                <div class="btn-view-group">
                    <div class="radio-group cal-opc">
                        <label v-for="opt in optionMode" :for="`view-${opt.class}`">
                            <input type="radio" name="view" :id="`view-${opt.class}`"
                                :checked="viewMode.class == opt.class" @click="updateViewMode(opt.class)" />
                            <span>{{opt.name}}</span>
                        </label>
                    </div>
                </div>
            </div>
            <div class="pure-u-1-1 pure-u-md-1-12"></div>
            <div class="pure-u-1-1 pure-u-md-3-8">
                <div class="btn-view-group">
                    <div class="radio-group" style="gap: .7rem; padding-top: 0; justify-content: space-evenly;">
                        <button style="padding: 5px .5rem;" @click="openModal(1)">Agregar Hito</button>
                        <button style="padding: 5px .5rem;" @click="toggleHoliday">
                            {{currentDay.isHoliday ? 'Desmarcar festivo' : 'Marcar festivo'}}
                        </button>
                    </div>
                </div>
            </div>
            <div class="pure-u-1-1 pure-u-md-1-12" style="text-align: center;">
                <img src="../../img/cli/excel_02.png" alt="Excel" class="pure-img logoExcel" @click="exportExcelDays()"
                    title="Descargar datos a Excel" />
            </div>
            <div class="pure-u-1-1 pure-u-md-5-24">
                <select v-model="pro_filter" @change="setViewMonths">
                    <option :value="null">Toda la sala</option>
                    <option v-for="pro in proyectos" :value="pro.id_proyecto">
                        {{pro.nombre}}
                    </option>
                </select>
            </div>
        </div>

        <div style="display: flex; gap: 5px; height: calc(100vh - 16rem);">
            <div
                :class="`calendar pure-u-1-1 ${viewMode.class == 'm6' || viewMode.class == 'm12' ? 'pure-u-md-1-1' : 'pure-u-md-1-3'} ` + viewMode.class">
                <div class="cal-month"
                    v-for="i in Array.from({length: viewMode.months}, (_, i) => i + viewMode.initMonth)"
                    v-bind:class="{'cal-sel-month': viewMonths[nameMonths[i]].selected}">
                    <div class="cal-header">
                        <div class="cal-name-month">
                            <span>{{`${nameMonths[i]} - ${viewMonths[nameMonths[i]].year}`}}</span>
                        </div>
                    </div>
                    <div class="cal-header">
                        <div class="cal-name-day" v-for="name in nameDays">
                            <span>{{name}}</span>
                        </div>
                    </div>
                    <div class="cal-matrix">
                        <div class="cal-day" v-for="day in viewMonths[nameMonths[i]].days"
                            :id="`mat-m${day.month}-d${day.monthDay}-${day.currentMonth ? 'c' : day.viewMonth}`"
                            v-bind:class="{'cal-today': day.isToday, 'cal-fade-day': !day.currentMonth, 
                            'cal-sel-day': day.isSelected, 'cal-holiday': day.isHoliday, 
                            'cal-sel-week': viewMode.class == 's1' && currentDay.weekCount == day.weekCount && i == currentDay.month}"
                            @click="day.currentMonth && selDay(day, true)" :style="day.events && day.events.filter(e => e.festivo != '1').length ? 
                            `background-color: ${day.events.filter(e => e.festivo != '1')[0].color}40;` : ''"
                            @dblclick="day.currentMonth && day.events && day.events.filter(e => e.festivo != '1').length && openModal(3)">
                            <span>
                                {{day.monthDay}}
                            </span>
                            <div class="hide-editor" v-bind:class="{'cal-event-count': day.events && 
                            day.events.filter(e => e.festivo != '1').length}">
                                <span>{{day.events.filter(e => e.festivo != '1').length}}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="pure-u-1-1 pure-u-md-2-3 cal-table" v-if="viewMode.class == 's1' || viewMode.class == 'm1'">
                <table class="dataTable">
                    <thead>
                        <tr>
                            <th style="width: 16%;">Fecha</th>
                            <th style="width: 33%;">Titulo</th>
                            <th style="width: 14%;">Tipo</th>
                            <th style="width: 21%;">Categorías (#)</th>
                            <th style="width: 16%;">Hora</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr v-for="day in tableDays" @click="day.day.currentMonth && selDay(day.day)"
                            @dblclick="day.day.currentMonth && day.event ? (openModal(2, day.event)) : day.day.currentMonth ? openModal(1) : null"
                            :id="`tab-m${day.day.month}-d${day.day.monthDay}`"
                            v-bind:class="{'cal-table-selected': day.day.isSelected, 'cal-table-today': day.day.isToday, 'cal-deshabilitada': !day.day.currentMonth}"
                            :style="day.color ? 'background: ' + day.color + '40;' : day.day.isSelected ? 'background: #ddd;' : null">
                            <td>{{formatDatetime(null, 'date', day.day.date)}}</td>
                            <td>{{day.e_titulo}}</td>
                            <td>{{day.e_tipo}}</td>
                            <td :style="day.e_categorias.length > 1 ? 'padding: 0;' : ''">
                                <span v-if="!day.e_categorias.length">-</span>
                                <span v-else-if="day.e_categorias.length == 1">{{day.e_categorias[0]}}</span>
                                <div v-else style="text-align: center;"
                                    @mouseenter="tooltipVisible = true; tooltipMsg = day.e_categorias.join(`&lt;br&gt;`)"
                                    @mouseleave="tooltipVisible = false;" @mousemove="updateCursor">
                                    <span class="cal-event-count">{{day.e_categorias.length}}</span>
                                </div>
                            </td>
                            <td>{{day.e_hora}}</td>
                        </tr>
                    </tbody>
                </table>
                <div v-if="tooltipVisible" class="cursor-tooltip" v-html="tooltipMsg"
                    :style="{ top: tooltipY + 'px', left: tooltipX + 'px' }">
                </div>
            </div>
        </div>
    </div>
    <div class="cal-modal-overlay" id="modalOverlay" @click="closeModal($event)">
        <div class="modal-container pure-g" v-if="mode == 1 || mode == 2">
            <div class="modal-scroll">
                <img src="../../img/ico/svg/cerrar-transparente.svg" @click="closeModal($event, true)"
                    class="modal-cerrar">
                <div class='pure-u-1-1 pure-u-md-1-1'>
                    <h2 style="text-align: center;">{{ formatDatetime(null, 'date', selDate) }}</h2>
                </div>
                <div class='pure-u-1-1 pure-u-md-1-1 formInputStandard'>
                    <span>Titulo</span>
                    <input type='text' maxlength="100" v-model="hito.titulo" />
                </div>
                <div class='pure-u-7-24 pure-u-md-7-24 formInputStandard'>
                    <span>Tipo de Hito</span>
                    <div style="display: flex; justify-content: space-around;">
                        <select v-model="eventType" @change="cleanType">
                            <option value="Sala">Sala</option>
                            <option value="Proyecto">Proyecto</option>
                            <option value="Torre">Torre</option>
                            <option value="Inmueble">Inmueble</option>
                        </select>
                    </div>
                </div>
                <div class='pure-u-7-24 pure-u-md-7-24 formInputStandard'>
                    <span>Sala</span>
                    <div style="display: flex; justify-content: space-around;">
                        <select disabled v-model="hito.id_sala_venta">
                            <option :value="sala.id_sala_venta">{{sala.sala_venta}}</option>
                        </select>
                    </div>
                </div>

                <div class='pure-u-5-24 pure-u-md-5-24 formInputStandard' style="text-align: center;">
                    <span>Color</span>
                    <input type='color' v-model="hito.color" style="margin-top: 2px;" />
                </div>
                <div class='pure-u-5-24 pure-u-md-5-24 formInputStandard'>
                    <span>Hora</span>
                    <input type='time' v-model="hito.hora" />
                </div>

                <div class='pure-u-7-24 pure-u-md-7-24 formInputStandard'>
                    <span>Proyecto</span>
                    <select v-model="hito.id_proyecto" :disabled="eventType === 'Sala'"
                        @change="delete hito.id_torre; delete hito.id_unidad;">
                        <option v-for="pro in proyectos" :value="pro.id_proyecto">
                            {{pro.nombre}}
                        </option>
                    </select>
                </div>
                <div class='pure-u-7-24 pure-u-md-7-24 formInputStandard'>
                    <span>Torre</span>
                    <select v-model="hito.id_torre"
                        :disabled="!hito.id_proyecto || eventType === 'Sala' || eventType === 'Proyecto'"
                        @change="delete hito.id_unidad;">
                        <option v-for="t in torres.filter(t => t.id_proyecto === hito.id_proyecto)" :value="t.id_torre">
                            {{t.torre}}
                        </option>
                    </select>
                </div>
                <div class='pure-u-7-24 pure-u-md-7-24 formInputStandard'>
                    <span>Inmueble</span>
                    <select v-model="hito.id_unidad" :disabled="!hito.id_torre || eventType !== 'Inmueble'">
                        <option v-for="un in unidades.filter(un => un.id_torre === hito.id_torre)"
                            :value="un.id_unidad">
                            {{un.unidad}}
                        </option>
                    </select>
                </div>

                <span style="display: block; padding: .5rem; padding-bottom: 0;">
                    Agendar a las categorías:
                </span>
                <div class="modal-check-cont">
                    <div class='pure-u-1-2 pure-u-md-1-6' style="overflow: hidden;" v-for="cargo in cargos">
                        <label class="check" style="word-break: break-word;">
                            <input type="checkbox" value='1' v-model="cargo.checked" />
                            <span class="checkmark"></span>
                            {{cargo.cargo}}
                        </label>
                    </div>
                </div>

                <div class='pure-u-1-1 pure-u-md-4-5 formInputStandard' style="padding: .5rem;">
                    <span>Repetir</span>
                    <div class="radio-group cal-opc" style="width: 98%;">
                        <label v-for="fre in frecuencias" :for="`freq-${fre.name}`" @click="onChangeFreq(fre)">
                            <input type="radio" name="freq" :id="`freq-${fre.name}`" :checked="fre.checked" />
                            <span>{{fre.name}}</span>
                        </label>
                    </div>
                </div>
                <div class='pure-u-1-1 pure-u-md-1-5 formInputStandard' style="padding: .5rem;">
                    <span>Hasta</span>
                    <input type="date" v-model="hito.limite" style="margin-top: 2px;" :disabled="!hito.frecuencia"
                        :min="hito.fecha ? hito.fecha.split(' ')[0] : formatDatetime(null, 'bdate', selDate)">
                </div>

                <div class='pure-u-1-1 pure-u-md-1-1 formInputStandard'>
                    <span>Descripción</span>
                    <textarea maxlength="255" v-model="hito.descripcion"
                        style="width: 100%; height: 100px; resize: none; font-size: 14px;"></textarea>
                </div>
                <div style="display: flex; width: 100%; gap: 4rem; justify-content: center;">
                    <div class='pure-u-1-1 pure-u-md-1-4 formInputStandard'>
                        <button @click="onCancel">Cancelar</button>
                    </div>
                    <div class='pure-u-1-1 pure-u-md-1-4 formInputStandard'>
                        <button @click="onSave">Guardar</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="modal-container pure-g" v-if="mode == 3" style="position: relative;">
            <img src="../../img/ico/svg/cerrar-transparente.svg" @click="closeModal($event, true)"
                class="modal-cerrar events">
            <div class="pure-u-1-1">
                <h2 style="text-align: center; margin-bottom: 1rem;">
                    Hitos del {{ formatDatetime(null, 'date', selDate) }}
                </h2>
            </div>
            <div class="event-list">
                <div v-for="e in currentDay.events.filter(e => e.festivo != '1')" class="event-card pure-g"
                    :style="`border: 1px solid ${e.color}90; border-left: 6px solid ${e.color}; background-color: ${e.color}10;`">
                    <div class="pure-u-5-6 pure-u-md-5-6">
                        <h4 class="event-title">
                            {{ e.titulo }} - {{ getMetaHito(e) }} - {{ formatDatetime(e.fecha, 'time') }}
                            ({{(frecuencias.find(f => f.value == e.frecuencia) || frecuencias[0]).name}})
                        </h4>
                        <p class="event-description">{{ e.descripcion }}</p>
                    </div>
                    <div class="event-edit-btn pure-u-1-12 pure-u-md-1-12">
                        <img src="../../img/ico/svg/pencil.svg" alt="Editar" @click="selEvent(e)">
                    </div>
                    <div class="event-edit-btn pure-u-1-12 pure-u-md-1-12">
                        <img src="../../img/ico/svg/cerrar-transparente.svg" alt="Eliminar" @click="reqDeleteEvent(e)">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>