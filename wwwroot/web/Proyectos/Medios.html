<!--Imagenes y videos -->
<div class="pure-g" style="height: max-content">
    <div class="pure-u-1-24"></div>
    <div class="pure-u-22-24" style="margin: 0em 0em 0.5em 0em;">
        <div class="pure-g steps">
            <div v-for="(tab, index) in mediaTabs" :key="index" class="pure-u-1-1 pure-u-md-1-6">
                <div class="wizarTab wizarTabNoSelect" :class="tabClasses[index]" @click="setSubmode(index)">
                    {{ tab }}
                </div>
            </div>
        </div>
    </div>
    <div class="pure-u-1-24"></div>
    <div class="pure-u-1-24"></div>
    <div class="pure-u-22-24 menuCard" style="height: calc(100vh - 14rem); overflow-y: auto; padding: 1em 1em 0 1em !important ">
        <div class="pure-g" v-show="submode == 0">
            <div class='pure-u-1-1 pure-u-md-1-1'>
                <div class='pure-u-1-1 pure-u-md-1-1 formDivision' style="font-size: 1.5em;">
                    Visualización y Secuencia de agrupaciones en el Carrusel del Proyecto
                </div>
                <div class="contenedor-tablas">
                    <div v-for="(tabla, i) in tablas" :key="i" class="tabla-contenedor">
                        <div :class="{ deshabilitada: tabla.activo, 'tabla-seleccionada': selected.tablaIndex === i }" class="tabla-scroll">
                            <table class="dataTable">
                                <thead>
                                    <tr class="th-fijo">
                                        <th>{{ tabla.titulo }}</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr v-for="(item, j) in tabla.datos" :key="j" @click="selectItem(i, j)">
                                        <!-- <td v-if="editando.tablaIndex === i 
                                        && editando.itemIndex === j 
                                        && tabla.titulo !== 'Agrupaciones Generales' 
                                        && tabla.titulo !== 'Imágenes Principales' 
                                        && !tabla.activo">
                                            <input type="text" v-model="tabla.datos[j]" @blur="onItemEditFinish(i, j)"
                                                @keyup.enter="onItemEditFinish(i, j)" ref="editInput" />
                                        </td> -->
                                        <td style="height: 35px; width: 100%;" :title="item"
                                            :class="{ 'selected-item': selected.itemIndex === j && selected.tablaIndex === i }" @click="selectItem(i, j)">
                                            <div class="contenido-celda">{{ item }}</div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="tabla-toggle">
                            <div class="toggle-switch" :class="{ inactive: !tabla.activo }">
                                <input :id="'toggle-' + i" type="checkbox" v-model="tabla.activo" class="toggle-input"
                                    :class="{ errorInput: tabla.error }" />
                                <label class="toggle-label" :for="'toggle-' + i"></label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="pure-u-1 icon-buttons">
                    <span class="icon-button" @click="moveRow('up')">
                        <img src="../../img/ico/up.png" alt="">
                        <span>Subir ítem</span>
                    </span>
                
                    <span class="icon-button" @click="moveRow('down')">
                        <img src="../../img/ico/down.png" alt="">
                        <span>Bajar ítem</span>
                    </span>
                
                    <span class="icon-button" @click="addRowSec">
                        <img src="../../img/ico/addRow.png" alt="">
                        <span>Insertar ítem</span>
                    </span>
                
                    <span class="icon-button" @click="deleteRow">
                        <img src="../../img/ico/delete.png" alt="">
                        <span>Eliminar ítem</span>
                    </span>
                    <span class="icon-button" @click="addRowVid" @click="openPrevi">
                        <img src="../../img/ico/eye-64.png" alt="">
                        <span>Previsualizar</span>
                    </span>
                </div>
            </div>
        </div>
        <div class="pure-g" v-show="submode == 1">
            <div class='pure-u-1-1 pure-u-md-1-1'>
                <div class='pure-u-1-1 pure-u-md-1-1 formDivision' style="font-size: 1.5em; margin-bottom:4px">
                    Logo, Slide y Planta General de Proyecto
                </div>
                <div class="image-upload-container">
                    <div class="pure-u-1-1 pure-u-md-1-3 image-upload-item">
                        Logo (< 2Mb) <label v-if="!logoPreview" for="archivo-logo" class="upload-label upload-area-vimg" @dragover.prevent
                            @drop.prevent="handleDrop($event, 'logoPreview')">
                            <span>Arrastra una imagen o haz clic</span>
                            </label>
                            <input accept="image/*" type="file" id="archivo-logo" class="hidden-input"
                                @change="previewImage($event, 'logoPreview')" />
                            <div v-if="logoPreview" class="image-card-preview">
                                <img :src="logoPreview" alt="Logo Preview" @click="expandImage('logo')" />
                                <div class="delete-btn" @click="removePreview('logo')">X</div>
                            </div>
                            <div v-if="tooltipVisible" class="cursor-tooltip" :style="{ top: tooltipY + 'px', left: tooltipX + 'px' }">
                                {{tooltipMsg}}
                            </div>
                    </div>
                    <div class="pure-u-1-1 pure-u-md-1-3 image-upload-item">
                        Slide 1 (< 2Mb) <label v-if="!slidePreview" for="archivo-slide" class="upload-label upload-area-vimg"
                            @dragover.prevent @drop.prevent="handleDrop($event, 'slidePreview')">
                            <span>Arrastra una imagen o haz clic</span>
                            </label>
                            <input type="file" id="archivo-slide" class="hidden-input" @change="previewImage($event, 'slidePreview')" />
                            <div v-if="slidePreview" class="image-card-preview">
                                <img :src="slidePreview" alt="Slide 1 Preview" @click="expandImage('slide')" />
                                <div class="delete-btn" @click="removePreview('slide')">X</div>
                            </div>
                    </div>
                    <div class="pure-u-1-1 pure-u-md-1-3 image-upload-item">
                        Planta General Termómetro (< 2Mb) <label v-if="!plantaPreview" for="archivo-planta"
                            class="upload-label upload-area-vimg" @dragover.prevent @drop.prevent="handleDrop($event, 'plantaPreview')">
                            <span>Arrastra una imagen o haz clic</span>
                            </label>
                            <input type="file" id="archivo-planta" class="hidden-input" @change="previewImage($event, 'plantaPreview')" />
                            <div v-if="plantaPreview" class="image-card-preview">
                                <img :src="plantaPreview" alt="Planta Preview" @click="expandImage('planta')" />
                                <div class="delete-btn" @click="removePreview('planta')">X</div>
                            </div>
                    </div>
                    <div v-if="isExpanded.logo || isExpanded.slide || isExpanded.planta" class="image-modal" @click="closeModal">
                        <img v-if="isExpanded.logo" :src="logoPreview" class="expanded-image" />
                        <img v-if="isExpanded.slide" :src="slidePreview" class="expanded-image" />
                        <img v-if="isExpanded.planta" :src="plantaPreview" class="expanded-image" />
                    </div>
                </div>
            </div>
        </div>
        <div class="pure-g" v-show="submode == 2 && modeimg">
            <div class="pure-u-1-1">
                <div class='pure-u-1-1 pure-u-md-1-1 formDivision' style="font-size: 1.5em; margin-bottom:4px">
                    Imágenes de proyecto
                </div>
                <div class="pure-g">
                    <div class='pure-u-1-1 pure-u-md-1-24 positTex'>
                        <img class="pure-img logoExcel" src="../../img/ico/svg/delete.svg" @click="configclearAllImages"
                            title="Limpiar o eliminar imágenes">
                    </div>
                    <div class='pure-u-1-1 pure-u-md-1-4 positTex'>
                        Agrupación
                    </div>
                    <div class='pure-u-1-1 pure-u-md-1-4'>
                        <div class='formInputStandard positTex' >
                            <select v-model="selectImg" @change="checkAndLoad">
                                <option :value="null" disabled >[Seleccione uno ...]</option>
                                <option v-for='item in grupo_proyectos' v-bind:value='item.id_grupo_proyecto'>
                                    {{ item.grupo }}
                                </option>
                            </select>
                        </div>
                    </div>
                    <div class='pure-u-1-1 pure-u-md-1-4 positTex'>
                        <button @click="modImg" >Nuevo agrupación</button>
                    </div>  
                    <div class='pure-u-1-1 pure-u-md-1-24 positTex'></div>
                </div>
            </div>
            <div v-if="modeimg && ismodulImg" class="pure-u-1" @mousemove="updateCursor" @mouseleave="tooltipVisible = false"
                style="position: relative;padding-top: 1em;">
                <label for="file-input" class="preview-container" style="height: calc(100dvh - 17rem); cursor: pointer;"
                    @dragover.prevent="handleDragOver" @drop.prevent="handleDrop" @mouseenter="tooltipVisible = true"
                    @mouseleave="tooltipVisible = false">
                    <div v-if="previews.length === 0" class="center-absolute ">
                        Arrastra o haz clic para cargar imágenes.
                    </div>
                    <div class="image-card" v-for="(item, index) in previews" :key="index" draggable="true"
                        @dragstart="dragStart(index)"
                        @mouseenter="tooltipVisible = false" @mouseleave="tooltipVisible = true"
                        style="position: relative;">
                        <img :src="item.src" @click.stop.prevent="" 
                        @mouseenter="tooltipVisible = true; tooltipMsg = item.file.name"
                        @mouseleave="tooltipVisible = false; tooltipMsg = 'Arrastra o haz clic para cargar archivos.'"/>
                        <div class="image-name-overlay">{{ item.file.name }}</div>
                        <div class="delete-btn" @click.stop.prevent="removeImage(index)">✖</div>
                    </div>
                    <div v-if="tooltipVisible" class="cursor-tooltip" :style="{ top: tooltipY + 'px', left: tooltipX + 'px' }">
                        {{tooltipMsg}}
                    </div>
                </label>
                <input type="file" id="file-input" class="hidden-input" style="display: none;" multiple accept="*"
                    @change="handleFileChange" ref="fileInput" />
            </div>
        </div>
        <div v-if="!modeimg">
            <div class="pure-u-1-1">
                <div class='pure-u-1-1 pure-u-md-1-1 formDivision' style="font-size: 1.5em; margin-bottom:4px">
                    Imágenes de proyecto
                </div>
                <div class="pure-g menuCard" style="margin-top: 1em;">
                    <div class='pure-u-1-1 pure-u-md-1-4 positTex'>
                       Nueva Agrupación
                    </div>
                    <div class='pure-u-1-1 pure-u-md-1-4'>
                        <div class='formInputStandard positTex' >
                           <input type="text" v-model="newGrup">
                        </div>
                    </div>
                    <div class='pure-u-1-1 pure-u-md-1-4 positTex'>
                        <button @click="GrupUploadFiles" >Guardar agrupación</button>
                    </div>
                    <div class='pure-u-1-1 pure-u-md-1-24 positTex'></div>
                </div>
            </div>
         </div>
        <div class="pure-g" v-show="submode == 3">
            <div class="pure-u-1-1">
                <div class='pure-u-1-1 pure-u-md-1-1 formDivision' style="font-size: 1.5em; margin-bottom:4px">
                    Vídeos de Proyecto
                </div>
                <div v-if="modevid" class="pure-g">
                    <div class='pure-u-1-1 pure-u-md-1-4 positTex'>
                        Agrupación
                    </div>
                    <div  class='pure-u-1-1 pure-u-md-1-4'>
                        <div class='formInputStandard positTex'>
                            <select v-model="selectVid" @change="checkAndLoad">
                                <option :value="null" disabled>[Seleccione uno ...]</option>
                                <option v-for='item in grupo_proyectos' v-bind:value='item.id_grupo_proyecto'>
                                    {{ item.grupo }}
                                </option>
                            </select>
                        </div>
                    </div>
                    <div @click="modevid = false" class='pure-u-1-1 pure-u-md-1-5 positTex'>
                        <button>Nueva agrupación</button>
                    </div>
                </div>
                <div v-else class="pure-g menuCard" style="margin-top: 1em;">
                    <div class='pure-u-1-1 pure-u-md-1-4 positTex'>
                        Nueva Agrupación
                    </div>
                    <div class='pure-u-1-1 pure-u-md-1-4'>
                        <div class='formInputStandard positTex' >
                           <input type="text" v-model="newGrupVid">
                        </div>
                    </div>
                    <div class='pure-u-1-1 pure-u-md-1-4 positTex'>
                        <button @click="crearGrupoVideos" >Guardar agrupación</button>
                    </div>
                </div>
            </div>
            <div class="pure-u-1"></div>
            <div v-if="modevid && ismodulVid" class="pure-u-1 scroll-container">
                <table class="menuCard" style="width: 100%;">
                    <thead>
                        <tr>
                            <th style="width: 20.5%;">Video</th>
                            <th style="width: 40%;">Descripción</th>
                            <th>Link</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr v-for="(video, index) in videos" :key="index" :class="{ selected: selectedRow === index }"
                            @click="selectRow(index)">
                            <td><input v-model="video.nombre" class="full-width-input" /></td>
                            <td><input v-model="video.descripcion" class="full-width-input"/></td>
                            <td><input v-model="video.link" class="full-width-input"/></td>
                            <td class="center-delete-cell">
                                <div class="center-content" @click.stop>
                                    <span class="delete" @click.stop="removeRow(index)" title="Eliminar item" >✖</span>
                                    <img src="../../img/ico/menu/video.svg" class="video-icon" @click.stop="openModal(video.link)"  title="Ver video" >
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
                <div v-if="modalVideoId" class="modal-overlay" @click.self="closeModal">
                    <div class="modal-content">
                        <iframe :src="`https://www.youtube.com/embed/${modalVideoId}?autoplay=1&mute=1`" allow="autoplay; encrypted-media"
                            frameborder="0" allowfullscreen>
                        </iframe>
                    </div>
                </div>
            </div>
            <div v-if="modevid && ismodulVid" class="pure-u-1 icon-buttons" style="margin-top: 1.5em;">
                <span class="icon-button" @click="moveRowVid('up')">
                    <img src="../../img/ico/up.png" alt="">
                    <span>Subir ítem</span>
                </span>
                
                <span class="icon-button" @click="moveRowVid('down')">
                    <img src="../../img/ico/down.png" alt="">
                    <span>Bajar ítem</span>
                </span>
                
                <span class="icon-button" @click="addRowVid">
                    <img src="../../img/ico/addRow.png" alt="">
                    <span>Insertar ítem</span>
                </span>
            </div>
        </div>
        <div class="pure-g" v-show="submode == 4">
            <div class="pure-u-1-1">
                <div class='pure-u-1-1 pure-u-md-1-1 formDivision' style="font-size: 1.5em; margin-bottom:4px">
                    Recorridos Virtuales de Proyecto
                </div>
                <div v-if="modevir" class="pure-g">
                    <div class='pure-u-1-1 pure-u-md-1-4 positTex'>
                        Agrupación
                    </div>
                    <div  class='pure-u-1-1 pure-u-md-1-4'>
                        <div class='formInputStandard positTex'>
                            <select v-model="selectRvr" @change="checkAndLoad">
                                <option value='null' selected>[Seleccione uno ...]</option>
                                <option v-for='item in grupo_proyectos' v-bind:value='item.id_grupo_proyecto'>
                                    {{ item.grupo }}
                                </option>
                            </select>
                        </div>
                    </div>
                    <div @click="modevir = false" class='pure-u-1-1 pure-u-md-1-5 positTex'>
                        <button>Nueva agrupación</button>
                    </div>
                </div>
                <div v-else class="pure-g menuCard" style="margin-top: 1em;">
                    <div class='pure-u-1-1 pure-u-md-1-4 positTex'>
                        Nueva Agrupación
                    </div>
                    <div class='pure-u-1-1 pure-u-md-1-4'>
                        <div class='formInputStandard positTex' >
                           <input type="text" v-model="newGrupReco">
                        </div>
                    </div>
                    <div class='pure-u-1-1 pure-u-md-1-4 positTex'>
                        <button @click="crearGrupoReco" >Guardar agrupación</button>
                    </div>
                </div>
            </div>

            <div v-if="modevir && ismodulRvr" class="pure-u-1 scroll-container">
                <table class="menuCard" style="width: 100%;">
                    <thead>
                        <tr>
                            <th style="width: 20.5%;">Video</th>
                            <th style="width: 40%;">Descripción</th>
                            <th>Link</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr v-for="(video, index) in videosReco" :key="index" :class="{ selected: selectedRowReco === index }"
                            @click="selectRowReco(index)">
                            <td><input v-model="video.nombre" class="full-width-input" /></td>
                            <td><input v-model="video.descripcion" class="full-width-input"/></td>
                            <td><input v-model="video.link" class="full-width-input"/>{{}}</td>
                            <td class="center-delete-cell">
                                <div class="center-content" @click.stop>
                                    <span class="delete" @click.stop="removeRowReco(index)" title="Eliminar item">✖</span>
                                    <img src="../../img/ico/menu/video.svg" class="video-icon" @click.stop="openModal(video.link)" title="Ver video">
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
                <div v-if="modalVideoId" class="modal-overlay" @click.self="closeModal">
                    <div class="modal-content">
                        <iframe :src="`https://www.youtube.com/embed/${modalVideoId}?autoplay=1&mute=1`" frameborder="0"
                            allowfullscreen></iframe>
                    </div>
                </div>
            </div>
            <div v-if="modevir && ismodulRvr" class="pure-u-1 icon-buttons" style="margin-top: 1.5em;">
                <span class="icon-button" @click="moveRowReco('up')">
                    <img src="../../img/ico/up.png" alt="">
                    <span>Subir ítem</span>
                </span>
            
                <span class="icon-button" @click="moveRowReco('down')">
                    <img src="../../img/ico/down.png" alt="">
                    <span>Bajar ítem</span>
                </span>
            
                <span class="icon-button" @click="addRowReco">
                    <img src="../../img/ico/addRow.png" alt="">
                    <span>Insertar ítem</span>
                </span>
            </div>
        </div>
        <div class="pure-g" v-show="submode == 5">
            <div class="pure-u-1-1">
                <div class='pure-u-1-1 pure-u-md-1-1 formDivision' style="font-size: 1.5em; margin-bottom:4px">
                    Avances de obra de Proyecto
                </div>
                <div v-if="modeAvo" class="pure-g">
                    <div class='pure-u-1-1 pure-u-md-1-24 positTex'>
                        <img class="pure-img logoExcel" src="../../img/ico/svg/delete.svg" @click="configclearAllImages"  title="Limpiar o eliminar imágenes" >
                        </div>
                        <div class='pure-u-1-1 pure-u-md-1-4 positTex'>
                            Periodo
                        </div>
                        <div class='pure-u-1-1 pure-u-md-1-4'>
                            <div class='formInputStandard positTex'>
                                <select v-model="selectAvo" @change="checkAndLoad">
                                    <option value='null' selected>[Seleccione uno ...]</option>
                                    <option v-for='item in grupo_proyectos' v-bind:value='item.id_grupo_proyecto'>
                                        {{ item.grupo }}
                                    </option>
                                </select>
                            </div>
                        </div>
                        <div @click="modAvo" class='pure-u-1-1 pure-u-md-1-5 positTex'>
                            <button>Nueva agrupación</button>
                        </div>
                </div>
                <div v-if="!modeAvo">
                    <div class="pure-u-1-1">
                        <div class="pure-g menuCard" style="margin-top: 1em;">
                            <div class='pure-u-1-1 pure-u-md-1-4 positTex'>
                               Nueva Agrupación
                            </div>
                            <div class='pure-u-1-1 pure-u-md-1-4'>
                                <div class='formInputStandard positTex' >
                                   <input type="text" v-model="newGrup">
                                </div>
                            </div>
                            <div class='pure-u-1-1 pure-u-md-1-4 positTex'>
                                <button @click="GrupUploadFiles" >Guardar agrupación</button>
                            </div>
                            <div class='pure-u-1-1 pure-u-md-1-24 positTex'></div>
                        </div>
                    </div>
                 </div>
            </div>
            <div v-if="modeAvo && ismodulAvo" class="pure-u-1" @mousemove="updateCursor" @mouseleave="tooltipVisible = false"
                style="position: relative;padding-top: 1em;">
                <label for="file-input" class="preview-container" style="height: calc(100dvh - 25rem); cursor: pointer;"
                    @dragover.prevent="handleDragOver" @drop.prevent="handleDropAvo" @mouseenter="tooltipVisible = true"
                    @mouseleave="tooltipVisible = false">
                    <div v-if="previewsAvo.length === 0" class="center-absolute ">
                        Arrastra o haz clic para cargar imágenes o URLs de YouTube.
                    </div>
                    <div class="image-card" v-for="(item, index) in previewsAvo" :key="index" draggable="true"
                        @dragstart="dragStart(index)" @mouseenter="tooltipVisible = false" @mouseleave="tooltipVisible = true"
                        style="position: relative;">
                        <template v-if="item.isVideo">
                            <img :src="getPreviewSrc" @click.stop.prevent="showVideo(item.videoUrl)"
                                style="cursor: pointer; object-fit: cover; width: 100%; height: 100%;"
                                @mouseenter="tooltipVisible = true; tooltipMsg = 'Clic para ver el video'"
                                @mouseleave="tooltipVisible = false; tooltipMsg = 'Arrastra o haz clic para cargar archivos.'" />
                            <div class="image-name-overlay">Video</div>
                        </template>
                        <template v-else>
                            <img :src="item.src" @click.stop.prevent=""
                                @mouseenter="tooltipVisible = true; tooltipMsg = item.file.name"
                                @mouseleave="tooltipVisible = false; tooltipMsg = 'Arrastra o haz clic para cargar archivos.'" />
                            <div class="image-name-overlay">{{ item.file.name }}</div>
                        </template>
                        <div class="delete-btn" @click.stop.prevent="removeImage(index)">✖</div>
                    </div>
                    <div v-if="tooltipVisible" class="cursor-tooltip" :style="{ top: tooltipY + 'px', left: tooltipX + 'px' }">
                        {{tooltipMsg}}
                    </div>
                </label>
                <input type="file" id="file-input" class="hidden-input" style="display: none;" multiple accept="image/*"
                    @change="handleFileChange" ref="fileInput" />
            </div>
            <div v-if="videoId" class="video-modal" @click="closeVideo">
                <iframe width="80%" height="80%" :src="`https://www.youtube.com/embed/${videoId}?autoplay=1&mute=1`" frameborder="0"
                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                    allowfullscreen></iframe>
            </div>
        </div>
    </div>
    <div v-if="modalVisible" class="modal-overlay" @click.self="closePrevi">
        <div class="cont-rotafolio" id="cont-rotafolio" @mousemove="setShowBar" @mousedown="setShowBar">
            <div class="player-rotafolio">
                <img v-if="isImage(allItems[playIndex])" :src="getImageUrl(allItems[playIndex])">
            
                <iframe v-else-if="isVideo(allItems[playIndex])" @load="initVideo" id="v-player" :key="playIndex"
                    :src="formatURL(allItems[playIndex].previewSrc || allItems[playIndex].videoUrl)" frameborder="0"
                    allow="autoplay; encrypted-media" allowfullscreen>
                </iframe>
            </div>
            <div class="btn-bar-rotafolio" v-bind:class="{'show-bar': showBar && !isVideo(files[playIndex], false) && !loading}">
                <img src="../../img/ico/arrow.png" class="btn-rotafolio" @click="setIndex(-1)" style="transform: rotate(180deg);">
                <img src="../../img/ico/play.png" @click="play" 
                    class="btn-rotafolio" v-show="stop">
                <img src="../../img/ico/pause.png" @click="pause"
                    class="btn-rotafolio" v-show="!stop" style="background: white;">
                <img src="../../img/ico/arrow.png" class="btn-rotafolio" @click="setIndex(1)">
            </div>
        </div>
    </div>
    <div class="pure-u-1-1" style="text-align:center;padding-top: 1em;">
        <button v-if="submode == 2 || submode == 1 || submode == 5" @click="uploadFiles">Guardar</button>
        <button v-else-if="submode == 3" @click="insertarVideosEnGrupo()">Guardar</button>
        <button v-else-if="submode == 4" @click="insertarRecoEnGrupo()">Guardar</button>
        <button v-else-if="submode == 0" @click="guardarCambios()">Guardar</button>
    </div>
</div>